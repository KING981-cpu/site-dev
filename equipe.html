<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LearnCodigo | Enterprise OS</title>
    
    <!-- Frameworks & Fonts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;700&display=swap');

        :root {
            --accent: #06b6d4;
            --bg-dark: #030303;
            --card-bg: rgba(15, 15, 18, 0.6);
            --border: rgba(255, 255, 255, 0.05);
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg-dark);
            color: #f4f4f5;
            overflow: hidden;
            margin: 0;
        }

        .font-mono { font-family: 'JetBrains Mono', monospace; }

        .glass-panel {
            background: var(--card-bg);
            backdrop-filter: blur(16px);
            border: 1px solid var(--border);
        }

        .glass-btn {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .glass-btn:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: var(--accent);
        }

        .nav-active {
            background: rgba(6, 182, 212, 0.1);
            color: var(--accent) !important;
            border-right: 3px solid var(--accent);
        }

        .custom-scrollbar::-webkit-scrollbar { width: 5px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #18181b; border-radius: 10px; }
        
        .chat-bubble-me { background: var(--accent); color: black; border-radius: 12px 12px 2px 12px; }
        .chat-bubble-them { background: #18181b; color: #f4f4f5; border-radius: 12px 12px 12px 2px; border: 1px solid var(--border); }

        @keyframes pulse-cyan {
            0% { box-shadow: 0 0 0 0 rgba(6, 182, 212, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(6, 182, 212, 0); }
            100% { box-shadow: 0 0 0 0 rgba(6, 182, 212, 0); }
        }
        .voice-active { animation: pulse-cyan 2s infinite; }

        .status-badge {
            font-size: 8px;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 800;
            text-transform: uppercase;
        }
    </style>
</head>
<body class="h-screen flex text-sm selection:bg-cyan-500/30">

    <!-- Sidebar Principal -->
    <aside class="w-64 glass-panel border-r border-zinc-900 flex flex-col z-50">
        <div class="p-6 flex-1 overflow-y-auto custom-scrollbar">
            <div class="flex items-center gap-3 mb-10">
                <div class="w-10 h-10 bg-cyan-500 rounded-xl flex items-center justify-center shadow-lg shadow-cyan-500/20">
                    <i data-lucide="shield-check" class="w-6 h-6 text-black"></i>
                </div>
                <div>
                    <h1 class="font-bold text-lg tracking-tight leading-none">LearnCodigo</h1>
                    <span class="text-[10px] text-cyan-500 font-mono font-bold">ENTERPRISE OS</span>
                </div>
            </div>

            <nav class="space-y-1 mb-8" id="sidebar-nav">
                <p class="text-[10px] uppercase font-bold text-zinc-600 tracking-widest px-3 mb-2">Workspace</p>
                <button onclick="window.router.navigate('dashboard')" class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-zinc-400 hover:bg-white/5 transition-all nav-active" data-page="dashboard">
                    <i data-lucide="layout-grid" class="w-4 h-4"></i> Dashboards
                </button>
                <button onclick="window.router.navigate('chat')" class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-zinc-400 hover:bg-white/5 transition-all" data-page="chat">
                    <i data-lucide="message-square" class="w-4 h-4"></i> Comunicação
                </button>
                <button onclick="window.router.navigate('git')" class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-zinc-400 hover:bg-white/5 transition-all" data-page="git">
                    <i data-lucide="git-branch" class="w-4 h-4"></i> Git & Branches
                </button>
                <button onclick="window.router.navigate('pipeline')" class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-zinc-400 hover:bg-white/5 transition-all" data-page="pipeline">
                    <i data-lucide="activity" class="w-4 h-4"></i> Pipeline CI/CD
                </button>
            </nav>

            <div class="mt-8">
                <p class="text-[10px] uppercase font-bold text-zinc-600 tracking-widest px-3 mb-3">Canais de Voz</p>
                <div id="voice-channels-list" class="space-y-1 text-zinc-500">
                    <!-- Dinâmico via JS -->
                </div>
            </div>
        </div>

        <!-- Perfil Footer -->
        <div class="p-4 border-t border-zinc-900 bg-black/40">
            <div class="flex items-center gap-3 p-2 rounded-lg hover:bg-white/5 cursor-pointer">
                <div class="relative">
                    <div id="u-avatar" class="w-9 h-9 rounded-full bg-zinc-800 flex items-center justify-center font-bold text-xs uppercase border border-zinc-700">?</div>
                    <div class="absolute bottom-0 right-0 w-2.5 h-2.5 bg-emerald-500 border-2 border-[#030303] rounded-full"></div>
                </div>
                <div class="truncate">
                    <p id="u-name" class="font-bold text-xs truncate">Utilizador</p>
                    <p id="u-status-label" class="text-[9px] text-zinc-500 font-mono">OFFLINE</p>
                </div>
            </div>
        </div>
    </aside>

    <!-- Content Area -->
    <main class="flex-1 flex flex-col relative overflow-hidden bg-[radial-gradient(circle_at_50%_0%,rgba(6,182,212,0.05),transparent)]">
        <!-- Top Bar -->
        <header class="h-16 border-b border-zinc-900 flex items-center justify-between px-8 bg-black/20 backdrop-blur-md z-40">
            <div id="view-title" class="flex items-center gap-4 text-xs font-bold uppercase tracking-[0.2em] text-zinc-400">
                Dashboard <span class="text-white mx-2">/</span> Geral
            </div>
            <div class="flex items-center gap-4">
                <div id="online-team" class="flex -space-x-2 mr-4"></div>
                <div id="db-status" class="flex items-center gap-2 px-3 py-1 rounded-full bg-zinc-900 border border-zinc-800">
                    <div class="w-1.5 h-1.5 rounded-full bg-amber-500 shadow-[0_0_8px_rgba(245,158,11,0.5)]"></div>
                    <span class="text-[9px] font-bold text-zinc-400 uppercase tracking-tighter">Sincronizando...</span>
                </div>
            </div>
        </header>

        <!-- Viewport -->
        <div id="app-viewport" class="flex-1 overflow-y-auto custom-scrollbar p-8">
            <!-- Loading -->
            <div class="h-full flex flex-col items-center justify-center opacity-50">
                <div class="w-8 h-8 border-2 border-cyan-500/20 border-t-cyan-500 rounded-full animate-spin"></div>
            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, onSnapshot, addDoc, updateDoc, deleteDoc, serverTimestamp, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configuração Segura ---
        let db = null;
        let auth = null;
        let isFirebaseReady = false;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'learncodigo-dev';

        // --- Estado da Aplicação ---
        let currentUser = { uid: 'local-user', displayName: 'Developer Local' };
        let teamData = [];
        let activePage = 'dashboard';
        const VOICE_CHANNELS = ['Geral', 'Desenvolvimento', 'Cafetaria'];

        // --- Sistema de Router ---
        window.router = {
            navigate: (page) => {
                activePage = page;
                document.querySelectorAll('[data-page]').forEach(el => {
                    el.classList.toggle('nav-active', el.dataset.page === page);
                });
                renderView();
            }
        };

        // --- Inicialização ---
        const startApp = async () => {
            try {
                if (typeof __firebase_config !== 'undefined' && __firebase_config) {
                    const firebaseConfig = JSON.parse(__firebase_config);
                    const app = initializeApp(firebaseConfig);
                    auth = getAuth(app);
                    db = getFirestore(app);
                    
                    const initAuth = async () => {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    };

                    await initAuth();
                    onAuthStateChanged(auth, (user) => {
                        if (user) {
                            currentUser = user;
                            isFirebaseReady = true;
                            updateStatusUI('Conectado', 'bg-emerald-500');
                            setupFirestoreListeners();
                        }
                    });
                } else {
                    throw new Error("Config not found");
                }
            } catch (e) {
                console.warn("Utilizando modo Offline/Simulado.");
                updateStatusUI('Local Mode', 'bg-blue-500');
                // Gerar dados mock para teste local imediato
                teamData = [{ uid: 'local-user', displayName: 'Tu (Local)', metrics: { tcc: 140, commits: 52, tasks: 8, uptime: 98 }, currentRoom: 'Geral', voiceStatus: 'idle' }];
                renderView();
            }
        };

        const updateStatusUI = (text, colorClass) => {
            const el = document.getElementById('db-status');
            if (el) {
                el.innerHTML = `<div class="w-1.5 h-1.5 rounded-full ${colorClass} shadow-[0_0_8px_rgba(0,0,0,0.3)]"></div><span class="text-[9px] font-bold text-zinc-400 uppercase tracking-tighter">${text}</span>`;
            }
            document.getElementById('u-status-label').textContent = text.toUpperCase();
        };

        // --- Firestore Real-time Sync ---
        const setupFirestoreListeners = () => {
            const teamRef = collection(db, 'artifacts', appId, 'public', 'data', 'team');
            
            // Auto-registo do user
            setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'team', currentUser.uid), {
                uid: currentUser.uid,
                displayName: `Dev_${currentUser.uid.slice(0, 4)}`,
                metrics: { tcc: 120, commits: 34, tasks: 5, uptime: 92 },
                lastActive: serverTimestamp()
            }, { merge: true });

            onSnapshot(teamRef, (snap) => {
                teamData = snap.docs.map(d => d.data());
                updateOnlineBar();
                updateVoiceUI();
                if (activePage === 'dashboard' || activePage === 'chat') renderView();
            });
        };

        // --- Renderers ---
        const renderView = () => {
            const viewport = document.getElementById('app-viewport');
            const titleEl = document.getElementById('view-title');
            if (!viewport) return;

            viewport.innerHTML = '';
            
            switch(activePage) {
                case 'dashboard':
                    titleEl.innerHTML = `Dashboard <span class="text-white mx-2">/</span> Geral`;
                    renderDashboard(viewport);
                    break;
                case 'chat':
                    titleEl.innerHTML = `Comunicação <span class="text-white mx-2">/</span> Mensagens`;
                    renderChat(viewport);
                    break;
                case 'git':
                    titleEl.innerHTML = `Gitflow <span class="text-white mx-2">/</span> Branches`;
                    renderGit(viewport);
                    break;
                case 'pipeline':
                    titleEl.innerHTML = `DevOps <span class="text-white mx-2">/</span> CI/CD Pipeline`;
                    renderPipeline(viewport);
                    break;
            }
            lucide.createIcons();
        };

        const renderDashboard = (container) => {
            const user = teamData.find(u => u.uid === currentUser.uid) || teamData[0];
            const m = user.metrics;

            container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 animate-in fade-in duration-500">
                    <div class="glass-panel p-6 rounded-2xl border-l-4 border-cyan-500">
                        <p class="text-[10px] font-bold text-zinc-500 uppercase mb-4">Horas TCC</p>
                        <h3 class="text-3xl font-mono font-bold">${m.tcc}h</h3>
                    </div>
                    <div class="glass-panel p-6 rounded-2xl border-l-4 border-purple-500">
                        <p class="text-[10px] font-bold text-zinc-500 uppercase mb-4">Commits</p>
                        <h3 class="text-3xl font-mono font-bold">${m.commits}</h3>
                    </div>
                    <div class="glass-panel p-6 rounded-2xl border-l-4 border-emerald-500">
                        <p class="text-[10px] font-bold text-zinc-500 uppercase mb-4">Tarefas</p>
                        <h3 class="text-3xl font-mono font-bold">${m.tasks}</h3>
                    </div>
                    <div class="glass-panel p-6 rounded-2xl border-l-4 border-amber-500">
                        <p class="text-[10px] font-bold text-zinc-500 uppercase mb-4">Uptime</p>
                        <h3 class="text-3xl font-mono font-bold">${m.uptime}%</h3>
                    </div>

                    <div class="md:col-span-4 glass-panel p-8 rounded-3xl min-h-[300px] flex flex-col justify-center items-center text-center">
                        <i data-lucide="bar-chart-3" class="w-12 h-12 text-zinc-800 mb-4"></i>
                        <h2 class="text-xl font-bold mb-2">Relatório de Produtividade Ativo</h2>
                        <p class="text-zinc-500 max-w-md mx-auto">Os dados estão a ser recolhidos em tempo real de todas as estações de trabalho conectadas.</p>
                        <div class="mt-8 flex gap-4">
                            <div class="h-2 w-32 bg-zinc-800 rounded-full overflow-hidden">
                                <div class="h-full bg-cyan-500 w-[70%]"></div>
                            </div>
                            <span class="text-[10px] font-mono text-cyan-500">70% TARGET</span>
                        </div>
                    </div>
                </div>
            `;
        };

        const renderChat = (container) => {
            container.classList.add('flex', 'p-0');
            container.innerHTML = `
                <div class="w-72 border-r border-zinc-900 flex flex-col bg-black/20">
                    <div class="p-6 border-b border-zinc-900"><p class="font-bold text-xs uppercase tracking-widest text-zinc-500">Contactos</p></div>
                    <div class="flex-1 overflow-y-auto custom-scrollbar">
                        ${teamData.map(u => `
                            <div class="p-4 flex items-center gap-3 hover:bg-white/5 cursor-pointer border-b border-zinc-900/50">
                                <div class="w-8 h-8 rounded-full bg-zinc-800 flex items-center justify-center font-bold text-[10px]">${u.displayName[0]}</div>
                                <div>
                                    <p class="font-bold text-[11px]">${u.displayName}</p>
                                    <p class="text-[9px] text-emerald-500">Online</p>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                <div class="flex-1 flex flex-col items-center justify-center opacity-20">
                    <i data-lucide="messages-square" class="w-12 h-12 mb-4"></i>
                    <p class="font-mono text-[10px] uppercase">Selecione um chat para iniciar</p>
                </div>
            `;
        };

        const renderGit = (container) => {
            container.innerHTML = `
                <div class="max-w-3xl mx-auto space-y-4">
                    <h2 class="text-lg font-bold mb-6">Pull Requests Pendentes</h2>
                    <div class="glass-panel p-6 rounded-2xl flex items-center justify-between group">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 bg-zinc-900 rounded-lg flex items-center justify-center border border-zinc-800">
                                <i data-lucide="git-pull-request" class="w-5 h-5 text-purple-500"></i>
                            </div>
                            <div>
                                <p class="font-bold">feat: integration-engine-v2</p>
                                <p class="text-[10px] text-zinc-500 font-mono">branch: feature/core-updates -> main</p>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button class="px-4 py-2 bg-emerald-500/10 text-emerald-500 rounded-lg text-[10px] font-bold hover:bg-emerald-500 hover:text-white transition-all">APPROVE</button>
                            <button class="px-4 py-2 bg-zinc-800 rounded-lg text-[10px] font-bold">VIEW</button>
                        </div>
                    </div>
                </div>
            `;
        };

        const renderPipeline = (container) => {
             container.innerHTML = `
                <div class="max-w-3xl mx-auto space-y-6">
                    <div class="flex items-center justify-between">
                        <h2 class="text-lg font-bold">Pipeline Status</h2>
                        <span class="status-badge bg-emerald-500/20 text-emerald-500 border border-emerald-500/30">Healthy</span>
                    </div>
                    <div class="space-y-4">
                        ${['Build Stage', 'Test Suite', 'Security Audit', 'Deployment'].map((stage, i) => `
                            <div class="glass-panel p-4 rounded-xl flex items-center gap-4">
                                <div class="w-6 h-6 rounded-full bg-emerald-500 flex items-center justify-center text-black">
                                    <i data-lucide="check" class="w-3.5 h-3.5"></i>
                                </div>
                                <div class="flex-1">
                                    <p class="font-bold text-xs">${stage}</p>
                                    <div class="w-full bg-zinc-800 h-1 rounded-full mt-2">
                                        <div class="bg-emerald-500 h-full w-full"></div>
                                    </div>
                                </div>
                                <span class="text-[9px] font-mono text-zinc-600">COMPLETED</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        };

        const updateOnlineBar = () => {
            const bar = document.getElementById('online-team');
            if (!bar) return;
            bar.innerHTML = teamData.map(u => `
                <div class="w-7 h-7 rounded-full border-2 border-[#030303] bg-zinc-800 flex items-center justify-center text-[8px] font-bold uppercase" title="${u.displayName}">
                    ${u.displayName[0]}
                </div>
            `).join('');
        };

        const updateVoiceUI = () => {
            const list = document.getElementById('voice-channels-list');
            if (!list) return;
            list.innerHTML = VOICE_CHANNELS.map(ch => `
                <div class="mb-2">
                    <button class="w-full flex items-center justify-between px-3 py-1.5 rounded-lg hover:bg-white/5 transition-all group">
                        <div class="flex items-center gap-2">
                            <i data-lucide="mic-2" class="w-3.5 h-3.5"></i>
                            <span class="text-[11px]">${ch}</span>
                        </div>
                    </button>
                </div>
            `).join('');
            lucide.createIcons();
        };

        // --- Bootstrap ---
        window.onload = () => {
            startApp();
            lucide.createIcons();
            
            // Set Initial UI
            document.getElementById('u-name').textContent = currentUser.displayName;
            document.getElementById('u-avatar').textContent = currentUser.displayName[0];
        };

    </script>
</body>
</html>