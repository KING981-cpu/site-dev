<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LearnCodigo | Enterprise OS v2.0</title>
    
    <!-- Frameworks & Fonts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;700&display=swap');

        :root {
            --accent: #06b6d4;
            --bg-dark: #030303;
            --card-bg: rgba(15, 15, 18, 0.7);
            --border: rgba(255, 255, 255, 0.05);
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg-dark);
            color: #f4f4f5;
            overflow: hidden;
            margin: 0;
        }

        .font-mono { font-family: 'JetBrains Mono', monospace; }
        .glass-panel { background: var(--card-bg); backdrop-filter: blur(20px); border: 1px solid var(--border); }
        
        .nav-active {
            background: rgba(6, 182, 212, 0.1);
            color: var(--accent) !important;
            border-right: 3px solid var(--accent);
        }

        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #27272a; border-radius: 10px; }

        .chat-bubble-me { background: #075e54; color: white; border-radius: 8px 0px 8px 8px; }
        .chat-bubble-them { background: #262d31; color: #e9edef; border-radius: 0px 8px 8px 8px; }

        .status-pulse {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            box-shadow: 0 0 0 rgba(16, 185, 129, 0.4);
            animation: pulse 2s infinite;
        }
        @keyframes pulse { 0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); } 70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); } 100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); } }
    </style>
</head>
<body class="h-screen flex text-sm selection:bg-cyan-500/30">

    <!-- Sidebar Principal -->
    <aside class="w-64 glass-panel border-r border-zinc-900 flex flex-col z-50">
        <div class="p-6 flex-1 overflow-y-auto custom-scrollbar">
            <div class="flex items-center gap-3 mb-10">
                <div class="w-10 h-10 bg-cyan-500 rounded-xl flex items-center justify-center shadow-lg shadow-cyan-500/20">
                    <i data-lucide="shield-check" class="w-6 h-6 text-black"></i>
                </div>
                <div>
                    <h1 class="font-bold text-lg tracking-tight leading-none">LearnCodigo</h1>
                    <span class="text-[10px] text-cyan-500 font-mono font-bold">ENTERPRISE OS</span>
                </div>
            </div>

            <nav class="space-y-1 mb-8" id="sidebar-nav">
                <p class="text-[10px] uppercase font-bold text-zinc-600 tracking-widest px-3 mb-2">Workspace</p>
                <button onclick="window.router.navigate('dashboards')" class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-zinc-400 hover:bg-white/5 transition-all nav-active" data-page="dashboards">
                    <i data-lucide="layout-grid" class="w-4 h-4"></i> Dashboards
                </button>
                <button onclick="window.router.navigate('chat')" class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-zinc-400 hover:bg-white/5 transition-all" data-page="chat">
                    <i data-lucide="message-square" class="w-4 h-4"></i> Comunicação
                </button>
                <button onclick="window.router.navigate('pipeline')" class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-zinc-400 hover:bg-white/5 transition-all" data-page="pipeline">
                    <i data-lucide="activity" class="w-4 h-4"></i> Pipeline & Logs
                </button>
                <button onclick="window.router.navigate('git')" class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-zinc-400 hover:bg-white/5 transition-all" data-page="git">
                    <i data-lucide="git-branch" class="w-4 h-4"></i> Gestão de Branches
                </button>
            </nav>

            <div class="mt-8">
                <p class="text-[10px] uppercase font-bold text-zinc-600 tracking-widest px-3 mb-3">Equipe de Voz</p>
                <div id="voice-team-list" class="space-y-2 px-3">
                    <!-- Lista dinâmica de vozes -->
                </div>
                <button onclick="window.voice.requestJoin()" class="mt-4 w-full py-2 bg-zinc-900 hover:bg-zinc-800 border border-zinc-800 rounded-lg text-[10px] font-bold uppercase tracking-wider text-zinc-400 transition-all">
                    Solicitar Entrada
                </button>
            </div>
        </div>

        <!-- Perfil do Usuário -->
        <div class="p-4 border-t border-zinc-900 bg-black/40">
            <div class="flex items-center gap-3 p-2 rounded-lg">
                <div class="relative">
                    <div id="u-avatar" class="w-9 h-9 rounded-full bg-cyan-500/20 text-cyan-500 flex items-center justify-center font-bold text-xs border border-cyan-500/30">?</div>
                    <div id="u-status-dot" class="absolute bottom-0 right-0 w-2.5 h-2.5 bg-zinc-500 border-2 border-[#030303] rounded-full"></div>
                </div>
                <div class="truncate">
                    <p id="u-name" class="font-bold text-xs truncate">Conectando...</p>
                    <p id="u-role" class="text-[9px] text-zinc-500 font-mono uppercase">Offline</p>
                </div>
            </div>
        </div>
    </aside>

    <!-- Main Content Area -->
    <main class="flex-1 flex flex-col relative overflow-hidden bg-[radial-gradient(circle_at_50%_0%,rgba(6,182,212,0.03),transparent)]">
        <header class="h-16 border-b border-zinc-900 flex items-center justify-between px-8 bg-black/20 backdrop-blur-md z-40">
            <div id="view-title" class="flex items-center gap-4 text-xs font-bold uppercase tracking-[0.2em] text-zinc-400">
                Dashboard <span class="text-white mx-2">/</span> Geral
            </div>
            <div class="flex items-center gap-4">
                <div id="db-status" class="flex items-center gap-2 px-3 py-1 rounded-full bg-zinc-900 border border-zinc-800">
                    <div id="status-indicator-dot" class="w-1.5 h-1.5 rounded-full bg-amber-500"></div>
                    <span id="status-text" class="text-[9px] font-bold text-zinc-400 uppercase tracking-tighter">Sincronizando...</span>
                </div>
            </div>
        </header>

        <!-- Viewport Dinâmico -->
        <div id="app-viewport" class="flex-1 overflow-y-auto custom-scrollbar">
            <!-- Loader Inicial -->
            <div class="h-full flex flex-col items-center justify-center opacity-50">
                <div class="w-8 h-8 border-2 border-cyan-500/20 border-t-cyan-500 rounded-full animate-spin"></div>
                <p class="mt-4 font-mono text-[10px] text-zinc-500 uppercase tracking-widest">Iniciando Engine...</p>
            </div>
        </div>
    </main>

    <!-- Firebase SDK Modular -->
<script type="module">
    // 1. IMPORTAÇÃO DO SUPABASE
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

    // 2. CONFIGURAÇÃO (COLOQUE SUAS CHAVES AQUI)
    const SUPABASE_URL = 'https://ckamxscxszvtkvspksov.supabase.co'
    const SUPABASE_KEY = 'sb_publishable_hovcD6yN2KqWO-5Nb2gwMQ_zSna0xW3'
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY)

    // --- GLOBAL STATE ---
    let currentUser = null;

    // --- INITIALIZATION ---
    const initApp = async () => {
        try {
            // Tenta pegar sessão existente
            const { data: { session } } = await supabase.auth.getSession();
            
            if (!session) {
                // Se não tiver, faz login anônimo (Certifique-se que está ativo no painel do Supabase)
                const { data, error } = await supabase.auth.signInAnonymously();
                if (error) throw error;
                currentUser = data.user;
            } else {
                currentUser = session.user;
            }

            // Configura o perfil do usuário no banco
            await setupUserProfile(currentUser);
            
            // Inicia na Dashboard
            window.router.navigate('dashboards');
            
            // Inicia Sincronização em Tempo Real (Realtime)
            startRealtimeSync();

        } catch (err) {
            console.error("Erro de Conexão:", err);
            document.getElementById('status-text').innerText = "ERRO DE CONEXÃO";
        }
    };

    const setupUserProfile = async (user) => {
        const userName = `Dev_${user.id.slice(0, 4)}`;
        
        // Salva/Atualiza na sua tabela 'profiles'
        await supabase.from('profiles').upsert({
            id: user.id,
            name: userName,
            status: 'online',
            last_seen: new Date()
        });

        // Atualiza UI Lateral
        document.getElementById('u-name').innerText = userName.toUpperCase();
        document.getElementById('u-avatar').innerText = user.id[0].toUpperCase();
        document.getElementById('u-role').innerText = "Developer Ativo";
        document.getElementById('u-status-dot').className = "absolute bottom-0 right-0 w-2.5 h-2.5 bg-emerald-500 border-2 border-[#030303] rounded-full";
        document.getElementById('status-text').innerText = "ONLINE";
        document.getElementById('status-indicator-dot').className = "w-1.5 h-1.5 rounded-full bg-emerald-500";
    };

    // --- REALTIME ENGINE ---
    const startRealtimeSync = () => {
        // Escuta mudanças em perfis (equipe) e mensagens
        supabase
            .channel('global-updates')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'profiles' }, () => {
                updateTeamLists();
            })
            .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'global_messages' }, (payload) => {
                if(window.router.activePage === 'chat') {
                    // Adiciona mensagem na tela se o chat estiver aberto
                    appendMessageToUI(payload.new);
                }
            })
            .subscribe();
        
        updateTeamLists();
    };

    const updateTeamLists = async () => {
        const { data: team } = await supabase.from('profiles').select('*');
        if (!team) return;

        // Atualiza lista de "Equipe de Voz" na sidebar
        const voiceList = document.getElementById('voice-team-list');
        if(voiceList) {
            voiceList.innerHTML = team.map(member => `
                <div class="flex items-center gap-2 py-1">
                    <div class="w-2 h-2 rounded-full ${member.status === 'online' ? 'bg-emerald-500' : 'bg-zinc-600'}"></div>
                    <span class="text-zinc-400 text-[11px]">${member.name}</span>
                </div>
            `).join('');
        }
    };

    // --- MODULE: CHAT ---
    window.chat = {
        init: async () => {
            // Carrega mensagens iniciais
            const { data: messages } = await supabase
                .from('global_messages')
                .select('*')
                .order('created_at', { ascending: true })
                .limit(50);
            
            const container = document.getElementById('messages-container');
            if(messages) {
                container.innerHTML = messages.map(msg => renderMessageHTML(msg)).join('');
                container.scrollTop = container.scrollHeight;
            }
            
            // Mostra o input
            document.getElementById('chat-input-area').classList.remove('hidden');
        },
        send: async () => {
            const input = document.getElementById('message-input');
            if (!input.value.trim()) return;

            const content = input.value;
            input.value = '';

            await supabase.from('global_messages').insert([{
                user_id: currentUser.id,
                user_name: `Dev_${currentUser.id.slice(0, 4)}`,
                content: content
            }]);
        }
    };

    const renderMessageHTML = (data) => {
        const isMe = data.user_id === currentUser.id;
        return `
            <div class="flex ${isMe ? 'justify-end' : 'justify-start'} animate-in slide-in-from-bottom-2 duration-300">
                <div class="${isMe ? 'chat-bubble-me' : 'chat-bubble-them'} max-w-[70%] p-2 px-3 shadow-sm relative">
                    <p class="text-[10px] opacity-70 mb-1 font-bold">${isMe ? 'Você' : data.user_name}</p>
                    <p class="text-sm leading-relaxed">${data.content}</p>
                    <span class="text-[8px] opacity-50 block text-right mt-1 font-mono">${new Date(data.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                </div>
            </div>
        `;
    };

    const appendMessageToUI = (msg) => {
        const container = document.getElementById('messages-container');
        if(container) {
            container.insertAdjacentHTML('beforeend', renderMessageHTML(msg));
            container.scrollTop = container.scrollHeight;
        }
    };

    // --- ROUTER (ADAPTADO) ---
    window.router = {
        activePage: 'dashboards',
        navigate: (page) => {
            window.router.activePage = page;
            document.querySelectorAll('[data-page]').forEach(el => {
                el.classList.toggle('nav-active', el.dataset.page === page);
            });
            renderPage(page);
        }
    };

    // Chamar inicialização
    initApp();

    // Mantendo suas funções de renderização de página (DASHBOARD, PIPELINE ETC)
    // ... (restante do código de renderização do seu HTML original)
</script>
</body>
</html>
