<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LearnCodigo | Workspace & Dashboards</title>
    
    <!-- Dependências Externas -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;700&display=swap');

        :root {
            --accent: #06b6d4;
            --bg-dark: #030303;
            --card-bg: rgba(15, 15, 18, 0.6);
            --border: rgba(255, 255, 255, 0.05);
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg-dark);
            color: #f4f4f5;
            overflow: hidden;
        }

        .font-mono { font-family: 'JetBrains Mono', monospace; }

        .glass-panel {
            background: var(--card-bg);
            backdrop-filter: blur(16px);
            border: 1px solid var(--border);
        }

        .glass-btn {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .glass-btn:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: var(--accent);
        }

        .custom-scrollbar::-webkit-scrollbar { width: 5px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #18181b; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #27272a; }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .animate-enter { animation: slideIn 0.3s ease-out forwards; }

        .chat-bubble-me {
            background: var(--accent);
            color: black;
            border-radius: 14px 14px 2px 14px;
        }
        .chat-bubble-them {
            background: #18181b;
            color: #f4f4f5;
            border-radius: 14px 14px 14px 2px;
            border: 1px solid var(--border);
        }
        
        .voice-user-tag {
            animation: pulse-border 2s infinite;
        }
        
        @keyframes pulse-border {
            0% { border-color: rgba(6, 182, 212, 0.2); }
            50% { border-color: rgba(6, 182, 212, 0.8); }
            100% { border-color: rgba(6, 182, 212, 0.2); }
        }
    </style>
</head>
<body class="h-screen flex text-sm selection:bg-cyan-500/30">

    <!-- Sidebar Principal -->
    <aside class="w-64 glass-panel border-r border-zinc-900 flex flex-col z-50">
        <div class="p-6 flex-1 overflow-y-auto custom-scrollbar">
            <div class="flex items-center gap-3 mb-8">
                <div class="w-10 h-10 bg-cyan-500 rounded-xl flex items-center justify-center shadow-lg shadow-cyan-500/20">
                    <i data-lucide="layout-grid" class="w-6 h-6 text-black"></i>
                </div>
                <h1 class="font-bold text-lg tracking-tight">LearnCodigo<span class="text-cyan-500 italic text-xs ml-1 font-black">OS</span></h1>
            </div>

            <nav class="space-y-1">
                <p class="text-[10px] uppercase font-bold text-zinc-600 tracking-widest px-3 mb-2">Workspace</p>
                <button onclick="window.router.navigate('dashboard')" class="nav-link w-full flex items-center gap-3 px-3 py-2.5 rounded-lg hover:bg-white/5 transition-colors text-zinc-400 hover:text-white" data-page="dashboard">
                    <i data-lucide="bar-chart-3" class="w-4 h-4"></i> Dashboards
                </button>
                <button onclick="window.router.navigate('chat')" class="nav-link w-full flex items-center gap-3 px-3 py-2.5 rounded-lg hover:bg-white/5 transition-colors text-zinc-400 hover:text-white" data-page="chat">
                    <i data-lucide="message-square" class="w-4 h-4"></i> Comunicação
                </button>
                <button onclick="window.router.navigate('pipeline')" class="nav-link w-full flex items-center gap-3 px-3 py-2.5 rounded-lg hover:bg-white/5 transition-colors text-zinc-400 hover:text-white" data-page="pipeline">
                    <i data-lucide="activity" class="w-4 h-4"></i> Pipeline
                </button>
                <button onclick="window.router.navigate('branches')" class="nav-link w-full flex items-center gap-3 px-3 py-2.5 rounded-lg hover:bg-white/5 transition-colors text-zinc-400 hover:text-white" data-page="branches">
                    <i data-lucide="git-pull-request" class="w-4 h-4"></i> Pull Requests
                </button>
            </nav>

            <div class="mt-8">
                <p class="text-[10px] uppercase font-bold text-zinc-600 tracking-widest px-3 mb-2">Canais de Voz</p>
                <div id="voice-rooms" class="space-y-1">
                    <!-- Dinâmico -->
                </div>
            </div>
        </div>

        <div class="p-4 border-t border-zinc-900 bg-black/40">
            <div class="flex items-center gap-3 p-2 rounded-lg hover:bg-white/5 cursor-pointer transition-all">
                <div class="relative">
                    <div id="user-avatar" class="w-9 h-9 rounded-full bg-zinc-800 flex items-center justify-center font-bold text-xs uppercase border border-zinc-700">?</div>
                    <div class="absolute bottom-0 right-0 w-2.5 h-2.5 bg-emerald-500 border-2 border-[#030303] rounded-full"></div>
                </div>
                <div class="truncate">
                    <p id="user-display-name" class="font-bold text-xs truncate">A ligar...</p>
                    <p class="text-[10px] text-zinc-500 font-mono">Senior Dev</p>
                </div>
            </div>
        </div>
    </aside>

    <main id="main-content" class="flex-1 flex flex-col relative overflow-hidden bg-[radial-gradient(circle_at_50%_0%,rgba(6,182,212,0.05),transparent)]">
        <header class="h-16 border-b border-zinc-900 flex items-center justify-between px-8 bg-black/20 backdrop-blur-md z-40">
            <div id="header-title" class="flex items-center gap-4">
                <h2 class="text-sm font-bold uppercase tracking-widest text-zinc-400">Página Inicial</h2>
            </div>
            <div class="flex items-center gap-4">
                <div id="active-team-list" class="flex -space-x-2 mr-4"></div>
                <button class="p-2 glass-btn rounded-full"><i data-lucide="bell" class="w-4 h-4"></i></button>
                <button class="p-2 glass-btn rounded-full text-cyan-500"><i data-lucide="zap" class="w-4 h-4 fill-current"></i></button>
            </div>
        </header>

        <div id="app-viewport" class="flex-1 overflow-y-auto custom-scrollbar p-8">
            <div class="flex items-center justify-center h-full flex-col gap-4">
                <div class="w-12 h-12 border-2 border-cyan-500/20 border-t-cyan-500 rounded-full animate-spin"></div>
                <p class="text-xs font-mono text-zinc-500 animate-pulse">A carregar interface...</p>
            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, onSnapshot, addDoc, updateDoc, deleteDoc, serverTimestamp, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configuração ---
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'learn-codigo-workspace';

        // --- Estado Global ---
        let currentUser = null;
        let activePage = 'dashboard';
        let teamData = [];
        let analytics = { individual: {}, collective: {} };
        let selectedChatId = null;
        const VOICE_ROOMS = ['Geral', 'Dev Room', 'Coffee Break', 'Reunião'];

        // --- Router ---
        window.router = {
            navigate: (page) => {
                activePage = page;
                renderPage();
                updateActiveLink();
            }
        };

        const updateActiveLink = () => {
            document.querySelectorAll('.nav-link').forEach(link => {
                if (link.dataset.page === activePage) {
                    link.classList.add('bg-cyan-500/10', 'text-cyan-500');
                    link.classList.remove('text-zinc-400');
                } else {
                    link.classList.remove('bg-cyan-500/10', 'text-cyan-500');
                    link.classList.add('text-zinc-400');
                }
            });
        };

        // --- Voice Logic ---
        window.joinVoice = async (roomId) => {
            if (!currentUser) return;
            const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'team', currentUser.uid);
            
            // Se já estiver na sala, sai (toggle)
            const currentData = teamData.find(u => u.uid === currentUser.uid);
            const newRoom = currentData?.currentRoom === roomId ? null : roomId;
            
            await updateDoc(userRef, { currentRoom: newRoom });
        };

        const renderVoiceRooms = () => {
            const container = document.getElementById('voice-rooms');
            if (!container) return;

            container.innerHTML = VOICE_ROOMS.map(room => {
                const usersInRoom = teamData.filter(u => u.currentRoom === room);
                const isMeInRoom = teamData.find(u => u.uid === currentUser?.uid)?.currentRoom === room;

                return `
                    <div class="mb-1">
                        <button onclick="window.joinVoice('${room}')" 
                                class="w-full text-left px-3 py-2 text-xs rounded-lg flex items-center justify-between transition-all group ${isMeInRoom ? 'bg-cyan-500/10 text-cyan-500 font-bold' : 'text-zinc-500 hover:bg-white/5'}">
                            <div class="flex items-center gap-2">
                                <i data-lucide="volume-2" class="w-3.5 h-3.5"></i>
                                <span>${room}</span>
                            </div>
                            <i data-lucide="log-in" class="w-3 h-3 opacity-0 group-hover:opacity-100 transition-opacity"></i>
                        </button>
                        <div class="pl-8 space-y-1 mt-1">
                            ${usersInRoom.map(u => `
                                <div class="flex items-center gap-2 py-0.5 animate-enter">
                                    <div class="w-4 h-4 rounded-full bg-zinc-800 border border-cyan-500/30 flex items-center justify-center text-[8px] font-black voice-user-tag">
                                        ${u.displayName.slice(0,1)}
                                    </div>
                                    <span class="text-[10px] text-zinc-400 font-medium">${u.displayName}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');
            lucide.createIcons();
        };

        // --- Dashboards ---
        const renderDashboard = () => {
            const viewport = document.getElementById('app-viewport');
            const individual = analytics.individual[currentUser?.uid] || { tccHours: 128.5, commits: 14, tasks: 42 };
            
            viewport.innerHTML = `
                <div class="animate-enter">
                    <div class="flex items-center justify-between mb-8">
                        <div>
                            <h3 class="text-2xl font-bold tracking-tight">Painel de Controlo</h3>
                            <p class="text-zinc-500 text-xs mt-1">Monitorização de performance em tempo real.</p>
                        </div>
                    </div>

                    <div id="dashboard-content" class="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <div class="glass-panel p-6 rounded-2xl flex flex-col gap-4 border-l-4 border-l-cyan-500">
                            <div class="flex items-center justify-between">
                                <span class="text-[10px] font-bold uppercase text-zinc-500 tracking-widest">Tempo TCC</span>
                                <i data-lucide="clock" class="w-4 h-4 text-cyan-500"></i>
                            </div>
                            <h4 class="text-3xl font-mono font-bold">${individual.tccHours}<span class="text-sm ml-1 text-zinc-500">hrs</span></h4>
                        </div>
                        <div class="glass-panel p-6 rounded-2xl flex flex-col gap-4">
                            <div class="flex items-center justify-between">
                                <span class="text-[10px] font-bold uppercase text-zinc-500 tracking-widest">Commits</span>
                                <i data-lucide="git-commit" class="w-4 h-4 text-purple-500"></i>
                            </div>
                            <h4 class="text-3xl font-mono font-bold">${individual.commits}</h4>
                        </div>
                        <div class="glass-panel p-6 rounded-2xl flex flex-col gap-4">
                            <div class="flex items-center justify-between">
                                <span class="text-[10px] font-bold uppercase text-zinc-500 tracking-widest">Tarefas</span>
                                <i data-lucide="check-circle" class="w-4 h-4 text-emerald-500"></i>
                            </div>
                            <h4 class="text-3xl font-mono font-bold">${individual.tasks}</h4>
                        </div>
                        <div class="glass-panel p-6 rounded-2xl flex flex-col gap-4">
                            <div class="flex items-center justify-between">
                                <span class="text-[10px] font-bold uppercase text-zinc-500 tracking-widest">Sessão</span>
                                <i data-lucide="timer" class="w-4 h-4 text-amber-500"></i>
                            </div>
                            <h4 class="text-3xl font-mono font-bold">Ativa</h4>
                        </div>
                    </div>
                </div>
            `;
            lucide.createIcons();
        };

        // --- Chat ---
        const renderChat = () => {
            const viewport = document.getElementById('app-viewport');
            viewport.classList.add('p-0');
            viewport.innerHTML = `
                <div class="flex h-full animate-enter">
                    <div class="w-80 border-r border-zinc-900 bg-black/40 flex flex-col">
                        <div class="p-4 border-b border-zinc-900">
                            <input type="text" placeholder="Procurar membro..." class="w-full bg-zinc-900 border-none rounded-xl py-2 px-4 text-xs">
                        </div>
                        <div id="contact-list" class="flex-1 overflow-y-auto custom-scrollbar"></div>
                    </div>
                    <div id="chat-window" class="flex-1 flex flex-col bg-[#050505]">
                        <div class="flex-1 flex flex-col items-center justify-center opacity-20">
                            <i data-lucide="message-circle" class="w-16 h-16 mb-4"></i>
                            <p class="text-xs uppercase tracking-widest font-black">Seleciona um contacto para iniciar</p>
                        </div>
                    </div>
                </div>
            `;
            renderContacts();
            lucide.createIcons();
        };

        const renderContacts = () => {
            const container = document.getElementById('contact-list');
            if (!container) return;
            container.innerHTML = teamData.filter(u => u.uid !== currentUser?.uid).map(u => `
                <div onclick="window.openPrivateChat('${u.uid}', '${u.displayName}')" class="p-4 flex items-center gap-3 hover:bg-white/5 cursor-pointer border-b border-zinc-900 transition-colors">
                    <div class="w-11 h-11 rounded-full bg-zinc-800 flex items-center justify-center font-bold text-sm uppercase border border-zinc-700">${u.displayName.slice(0,1)}</div>
                    <div class="flex-1 truncate">
                        <p class="font-bold text-xs">${u.displayName}</p>
                        <p class="text-[10px] text-zinc-500">${u.currentRoom ? 'Em canal de voz' : 'Online'}</p>
                    </div>
                </div>
            `).join('');
        };

        window.openPrivateChat = (targetId, name) => {
            selectedChatId = [currentUser.uid, targetId].sort().join('_');
            const windowEl = document.getElementById('chat-window');
            windowEl.innerHTML = `
                <div class="h-16 border-b border-zinc-900 px-6 flex items-center justify-between bg-black/20">
                    <div class="flex items-center gap-3">
                        <div class="w-9 h-9 rounded-full bg-zinc-800 flex items-center justify-center font-bold text-xs">${name.slice(0,1)}</div>
                        <p class="text-xs font-bold">${name}</p>
                    </div>
                </div>
                <div id="messages-container" class="flex-1 overflow-y-auto p-6 space-y-4 custom-scrollbar flex flex-col"></div>
                <form id="chat-form" class="p-4 bg-zinc-900/30 border-t border-zinc-900 flex gap-4">
                    <input type="text" id="msg-input" placeholder="Escreve uma mensagem..." class="flex-1 bg-zinc-900 border-none rounded-xl px-4 py-2 text-sm">
                    <button type="submit" class="bg-cyan-500 text-black p-2 rounded-xl"><i data-lucide="send" class="w-4 h-4"></i></button>
                </form>
            `;
            lucide.createIcons();
            
            const msgRef = collection(db, 'artifacts', appId, 'public', 'data', 'private_chats', selectedChatId, 'messages');
            const q = query(msgRef, orderBy('timestamp', 'asc'), limit(50));
            onSnapshot(q, (snapshot) => {
                const container = document.getElementById('messages-container');
                if (!container) return;
                container.innerHTML = snapshot.docs.map(doc => {
                    const data = doc.data();
                    const isMe = data.sender === currentUser.uid;
                    return `
                        <div class="flex ${isMe ? 'justify-end' : 'justify-start'}">
                            <div class="max-w-[70%] p-3 ${isMe ? 'chat-bubble-me' : 'chat-bubble-them'}">
                                <p class="text-[11px]">${data.text}</p>
                            </div>
                        </div>
                    `;
                }).join('');
                container.scrollTop = container.scrollHeight;
            });

            document.getElementById('chat-form').onsubmit = async (e) => {
                e.preventDefault();
                const input = document.getElementById('msg-input');
                const text = input.value.trim();
                if (!text) return;
                await addDoc(msgRef, { sender: currentUser.uid, text, timestamp: serverTimestamp() });
                input.value = '';
            };
        };

        // --- Renderização Central ---
        const renderPage = () => {
            const viewport = document.getElementById('app-viewport');
            if (!viewport) return;
            viewport.classList.remove('p-0');
            const titleEl = document.getElementById('header-title');

            switch(activePage) {
                case 'dashboard':
                    titleEl.innerHTML = `<h2 class="text-sm font-bold uppercase tracking-widest text-zinc-400">Workspace / <span class="text-white">Dashboards</span></h2>`;
                    renderDashboard();
                    break;
                case 'chat':
                    titleEl.innerHTML = `<h2 class="text-sm font-bold uppercase tracking-widest text-zinc-400">Comunicação / <span class="text-white">Chat</span></h2>`;
                    renderChat();
                    break;
                case 'pipeline':
                    titleEl.innerHTML = `<h2 class="text-sm font-bold uppercase tracking-widest text-zinc-400">DevOps / <span class="text-white">Pipeline</span></h2>`;
                    viewport.innerHTML = `<div class="p-20 text-center opacity-40 animate-enter"><i data-lucide="activity" class="w-12 h-12 mx-auto mb-4"></i><p class="font-mono">Monitorização de Pipeline Ativa</p></div>`;
                    lucide.createIcons();
                    break;
                case 'branches':
                    titleEl.innerHTML = `<h2 class="text-sm font-bold uppercase tracking-widest text-zinc-400">Git / <span class="text-white">Pull Requests</span></h2>`;
                    viewport.innerHTML = `<div class="p-20 text-center opacity-40 animate-enter"><i data-lucide="git-branch" class="w-12 h-12 mx-auto mb-4"></i><p class="font-mono">Sem Pull Requests pendentes</p></div>`;
                    lucide.createIcons();
                    break;
            }
        };

        // --- Inicialização ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'team', user.uid);
                await setDoc(userRef, {
                    uid: user.uid,
                    displayName: `Dev_${user.uid.slice(0, 5)}`,
                    lastActive: serverTimestamp()
                }, { merge: true });

                document.getElementById('user-display-name').textContent = `Dev_${user.uid.slice(0, 5)}`;
                document.getElementById('user-avatar').textContent = user.uid.slice(0, 1);
                
                // Monitorização em Tempo Real da Equipa (Voz e Presença)
                onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'team'), (snap) => {
                    teamData = snap.docs.map(d => d.data());
                    
                    // Atualizar avatares no cabeçalho
                    const avatarList = document.getElementById('active-team-list');
                    if (avatarList) {
                        avatarList.innerHTML = teamData.slice(0, 5).map(u => `
                            <div class="w-7 h-7 rounded-full border-2 border-zinc-950 bg-zinc-900 flex items-center justify-center text-[9px] font-bold uppercase">
                                ${u.displayName.slice(0, 1)}
                            </div>
                        `).join('');
                    }

                    // Atualizar Canais de Voz
                    renderVoiceRooms();
                    
                    // Se estiver no chat, atualizar contactos
                    if (activePage === 'chat') renderContacts();
                }, (err) => console.error("Erro Firestore:", err));

                window.router.navigate('dashboard');
            }
        });

        const initAuth = async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        };

        initAuth().catch(console.error);
    </script>
</body>
</html>